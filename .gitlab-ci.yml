image: docker:latest

services:
  - docker:dind

stages:
  - build
  - deploy
  - migrate

build:
  stage: build
  script:
    - docker build -t myproject .
    - docker-compose -f docker-compose.yml build

deploy:
  stage: deploy
  script:
    - docker-compose -f docker-compose.yml up -d
    only:
    - staging
    - Testing
    - main

migrate:
  stage: migrate
  script:
    - docker-compose -f docker-compose.yml run web python manage.py migrate
    only:
    - staging
    - Testing
    - main

